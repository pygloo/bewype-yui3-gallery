YUI.add("bewype-editor",function(e){var d="",b="",a="",c=null;d+='<div class="{editorClass}-place">';d+="</div>";b+='<div class="{editorClass} {buttonClass}">';b+="</div>";a+='<div class="{editorClass}">';a+="{label}";a+='<div class="{spinnerClass}"></div>';a+="</div>";c=function(f){c.superclass.constructor.apply(this,arguments);};c.NAME="bewype-editor";c.NS="bewypeEditor";c.ATTRS={editorClass:{value:"yui3-bewype-editor",writeOnce:true,validator:function(f){return e.Lang.isString(f);}},activeButtons:{value:["height","width","padding-left","padding-top","bold","italic","underline","title","font-family","font-size","reset","apply"],writeOnce:true},panelNode:{value:null,writeOnce:true},selectionColor:{value:"#ddd",writeOnce:true,validator:function(f){return e.Lang.isString(f);}},spinnerLabelHeight:{value:"height",writeOnce:true,validator:function(f){return e.Lang.isString(f);}},spinnerLabelWidth:{value:"width",writeOnce:true,validator:function(f){return e.Lang.isString(f);}},spinnerLabelPaddingLeft:{value:"padding-left",writeOnce:true,validator:function(f){return e.Lang.isString(f);}},spinnerLabelPaddingTop:{value:"padding-top",writeOnce:true,validator:function(f){return e.Lang.isString(f);}},spinnerMaxHeight:{value:480,writeOnce:true,validator:function(f){return e.Lang.isNumber(f);}},spinnerMaxWidth:{value:640,writeOnce:true,validator:function(f){return e.Lang.isNumber(f);}}};e.extend(c,e.Plugin.Base,{_editor:null,_buttonDict:{},_spinnerButtons:["height","width","padding-left","padding-top"],_spinnerValues:{},_toggleButtons:["bold","italic","underline"],_pickerButtons:["title","font-family","font-size","color","background-color","url"],_pickerObjDict:{"background-color":e.Bewype.PickerColor,"color":e.Bewype.PickerColor,"font-family":e.Bewype.PickerFontFamily,"font-size":e.Bewype.PickerFontSize,"title":e.Bewype.PickerTitle,"url":e.Bewype.PickerUrl},_tagButtons:["bold","italic","title","underline","url"],_cssButtons:["font-family","font-size","color","background-color"],_selectedNodeList:null,_oMainCssdict:{},_initEditor:function(){var g=this.get("host"),h=this.get("editorClass"),f=e.Bewype.Utils.getCssDict(g),j=null,i=new e.Node.create('<div><div class="main" /></div>');i.one(".main").append(this._getInnerHTML(g));g.set("innerHTML","");j=new e.Node.create(e.substitute(d,{editorClass:h}));g.append(j);this._editor=new e.EditorBase({content:i.get("innerHTML")});this._editor.render(j);this._editor.after("nodeChange",e.bind(this._onEditorChange,this));return f;},_initContent:function(g){var f=this.get("host"),h=this.get("editorClass")+"-place",l=f.one("."+h),j=this._editor.getInstance().one("body"),i=j.one(".main"),k=null;j.setStyle("cssText","padding: 0; margin: 0; height: 100%; width: 100%;");k=function(n,q){var r=["height","width"].indexOf(n)!=-1,p=n.split("-"),o=p.indexOf("border")!=-1,m=p.indexOf("padding")!=-1;if(r||o||m){l.setStyle(e.Bewype.Utils.camelize(n),q);this._spinnerValues[n]=q;}else{if(n){i.setStyle(e.Bewype.Utils.camelize(n),q);}}return q;};this._oMainCssdict.height="100%";this._oMainCssdict.width="100%";i.setStyle("height","100%");i.setStyle("width","100%");e.JSON.stringify(g,e.bind(k,this));f.setStyle("cssText","");},_addSpinnerButton:function(k){var i=this.get("panelNode"),m=this.get("editorClass")+"-button",h=this.get("editorClass")+"-spinner-"+k,f=null,l=null,j=this._spinnerValues[k],g=j?parseInt(j.replace(/px/i,""),10):0;f=new e.Node.create(e.substitute(a,{editorClass:m,label:this.get(e.Bewype.Utils.camelize("spinner-label-"+k)),spinnerClass:h}));i.append(f);l=new e.Bewype.EntrySpinner({srcNode:f.one("."+h),max:this.get(e.Bewype.Utils.camelize("spinner-max-"+k)),min:0,value:g});l.render();l.on("entry:onChange",e.bind(this._onSpinnerEventChange,this,k));this._buttonDict[k]=l;},__buttonFactory:function(i,g,k){var h=this.get("panelNode"),l=this.get("editorClass"),m=null,f=null,j=null;m=new e.Node.create(e.substitute(b,{editorClass:l+"-button",buttonClass:l+"-button-"+i}));h.append(m);k.render(m);if(g==="button"){f="button:onClick";}else{f="button:onChange";}k.on(f,e.bind(this._onButtonEventChange,this,i));if(this._pickerButtons.indexOf(i)!=-1){j="button:onClick";k.before(j,e.bind(this._onButtonEventClick,this,i));}this._buttonDict[i]=k;},_addButton:function(f){var g=new e.Bewype.Button({label:f});this.__buttonFactory(f,"button",g);},_addToggleButton:function(f){var g=new e.Bewype.ButtonToggle({label:f});this.__buttonFactory(f,"toggle-button",g);},_addPickerButton:function(f,h){var g=new e.Bewype.ButtonPicker({label:f,pickerObj:h});this.__buttonFactory(f,"picker-button",g);},_initPanel:function(){var f=this.get("activeButtons");e.Object.each(this._spinnerButtons,function(h,g){if(f.indexOf(h)!=-1){this._addSpinnerButton(h);}},this);this._updateSpinnerMaxWidth();e.Object.each(this._toggleButtons,function(h,g){if(f.indexOf(h)!=-1){this._addToggleButton(h);}},this);e.Object.each(this._pickerButtons,function(h,g){if(f.indexOf(h)!=-1){this._addPickerButton(h,this._pickerObjDict[h]);}},this);this._addButton("reset");this._addButton("apply");},initializer:function(g){var f=this._initEditor();this._initContent(f);this._initPanel();e.publish("bewype-editor:onClose");e.publish("bewype-editor:onChange");},destructor:function(){if(!this._editor){return;}var l=this.get("host"),m=this.get("panelNode"),k=this.get("editorClass"),i="."+k+"-place",n=l.one(i),h=this._editor.getInstance().one("body"),f=h.one(".main"),g=f.one(".selection"),j=null;this._editor.hide();if(g){g.replace(this._getInnerHTML(g));}l.set("innerHTML",f.get("innerHTML"));j=function(o,p,q){if(p){if(o==="content"&&(p.split("-").indexOf("padding")!=-1||p==="height"||p==="width")){}else{l.setStyle(e.Bewype.Utils.camelize(p),q);}}return q;};e.JSON.stringify(e.Bewype.Utils.getCssDict(n),e.bind(j,this,"place"));e.JSON.stringify(e.Bewype.Utils.getCssDict(f),e.bind(j,this,"content"));this._editor.destroy();e.Object.each(this.get("activeButtons"),function(p,o){this._buttonDict[p].destroy();delete (this._buttonDict[p]);},this);m.all("."+k+"-button").each(function(p,o){p.remove();
});},_hasLeftBlank:function(f){if(f.length===0){return false;}else{if(f.substring(0,1).trim().length===0){return true;}}return false;},_hasRightBlank:function(f){if(f.length===0){return false;}else{if(f.substring(f.length-1,f.length).trim().length===0){return true;}}return false;},_getInnerHTML:function(i,g){var h=i._node?i._node:i,f=h.innerHTML,j="";j+=this._hasLeftBlank(f)?"&nbsp;":"";j+=f.trim();j+=this._hasRightBlank(f)?"&nbsp;":"";return g?j:j.trim()===""?null:new e.Node.create(j);},_getWorkingTagName:function(f,g){switch(f){case"bold":return"b";case"italic":return"i";case"title":var h=this._buttonDict[f];return g?h.getPrevious():h.getValue();case"underline":return"u";case"url":return"a";default:return"span";}},_removeTag:function(g,f,h){if(g&&g._node.innerHTML){g.all(f).each(function(l,j){var m=null,i=null,n=null;if(h){m=e.Bewype.Utils.getCssDict(l);if(m[h]){delete (m[h]);if(h==="background-color"){delete (m.display);}}e.Bewype.Utils.setCssDict(l,m);n=e.Object.keys(m).length;if(n!==0){return;}}i=this._getInnerHTML(l);if(!i){l.remove();}else{l.replace(this._getInnerHTML(l));}},this);}},_updateMainStyle:function(h,k){var j=this.get("host"),m=["height","width"].indexOf(h)!=-1,l=h.split("-"),f=l.indexOf("padding")!=-1,i=k?k:null,g=this._buttonDict[h].getValue();if(!i){if(m||f){i=j.one("."+this.get("editorClass")+"-place");}else{i=this._editor.getInstance().one(".main");}}i.setStyle(e.Bewype.Utils.camelize(h),g);},_clearSelection:function(i,g,f){if(i.clear){i.clear();}else{if(i.removeAllRanges){g.detach();i.removeAllRanges();}else{return;}}if(f!==false){var h=this._editor.getInstance(),j=h.one("body").one(".main");this._removeTag(j,".selection");}},_isFocusNodeFisrt:function(o){var h=this._editor.getInstance(),k=h.one("body").one(".main")._node,l=o.anchorNode,q=o.focusNode,g=o.anchorOffset,p=o.focusOffset,m=k.innerHTML?k.innerHTML:k.textContent,n=l.innerHTML?l.innerHTML:l.textContent,f=q.innerHTML?q.innerHTML:q.textContent,j=0,i=0;if(l==q){return p<g;}else{j=m.indexOf(n);i=m.indexOf(f);return i<j;}},_ensureRangeFirstNode:function(i,f,l){var h=this._editor.getInstance(),m=h.one("body").one(".main"),g=m._node,k=0;if(l.parentNode!=g){try{while(l.parentNode&&l.parentNode!=g){l=l.parentNode;k+=1;if(k==10){break;}}f.setStartBefore(l);}catch(j){return this._clearSelection(i,f);}}else{if(i.anchorOffset===0&&!i.anchorNode.previousSibling){f.setStart(g,0);}}return true;},_ensureRangeLastNode:function(i,f,l){var h=this._editor.getInstance(),m=h.one("body").one(".main"),g=m._node,k=0;if(l.parentNode!=g){try{while(l.parentNode&&l.parentNode!=g){l=l.parentNode;k+=1;if(k==10){break;}}f.setEndAfter(l);}catch(j){return this._clearSelection(i,f);}}return true;},_refreshSelectionNode:function(){var f=this._editor.getInstance(),g=f.one("body").one(".selection"),h=this.get("selectionColor");if(!g){return;}g.setStyle("backgroundColor",h);g.setStyle("display","inline-block");},_updateSelection:function(){var m=this.get("host"),i=this._editor.getInstance(),j=i.one("body"),f=j.one(".main"),h=f.one(".selection"),n=e.Bewype.Utils.getSelection(m),l=e.Bewype.Utils.getRange(n),o=null,g=null;if(!n.anchorNode||!n.focusNode){return this._clearSelection(n,l);}if(h){h.replace(this._getInnerHTML(h));}if(n.anchorNode!=n.focusNode||n.anchorOffset!=n.focusOffset){if(this._isFocusNodeFisrt(n)){o=n.focusNode;g=n.anchorNode;}else{o=n.anchorNode;g=n.focusNode;}if(!this._ensureRangeFirstNode(n,l,o)){return;}if(!this._ensureRangeLastNode(n,l,g)){return;}try{h=e.Node.create('<span class="selection"></span>');f.append(h);l.surroundContents(f.one(".selection")._node);}catch(k){return this._clearSelection(n,l);}this._clearSelection(n,l,false);}else{this._removeTag(f,".selection");}this._refreshButtons();this._refreshSelectionNode();},_onEditorChange:function(f){if(f.changedEvent.type=="dblclick"){}else{if(f.changedEvent.type=="mouseup"){this._updateSelection();}}},_resetSelection:function(f){var h=this._editor.getInstance(),i=h.one("body"),g=f?i.one(".main"):i.one(".selection");if(!g){return;}e.Object.each(["h1","h2","h3","h4","span","a","b","i","u"],function(l,j){this._removeTag(g,l);},this);},_getValueFromNode:function(f,j,h){var i=f?f.one(j):null,g=null;if(i){if(h==="url"){return i.get("href");}else{g=e.Bewype.Utils.getCssDict(i);return g[h];}}return null;},_refreshButtons:function(i,f){var g=this._editor.getInstance(),h=g.one("body").one(".selection"),j=f?[f]:this._toggleButtons;if(!h){i=true;}e.Object.each(j,function(n,m){if(this.get("activeButtons").indexOf(n)===-1){return;}var l=null;switch(n){case"bold":l=i?false:(h&&h.one("b")!==null);return this._buttonDict[n].setValue(l);case"italic":l=i?false:(h&&h.one("i")!==null);return this._buttonDict[n].setValue(l);case"underline":l=i?false:(h&&h.one("u")!==null);return this._buttonDict[n].setValue(l);case"font-family":case"font-size":case"color":case"background-color":l=i?false:this._getValueFromNode(h,"span",n);return this._buttonDict[n].setValue(l);case"url":l=i?false:this._getValueFromNode(h,"a",n);return this._buttonDict[n].setValue(l);}},this);},_onButtonEventChange:function(g,m){switch(g){case"apply":this.get("host").unplug(e.Bewype.Editor);return e.fire("bewype-editor:onClose");case"cancel":break;default:break;}var i=this._editor.getInstance(),k=i.one("body"),f=k.one(".main"),h=f.one(".selection"),o=this._buttonDict[g].getValue(),j=null,l=null,n=null;if(!h){if(this._cssButtons.indexOf(g)!=-1){this._updateMainStyle(g);return e.fire("bewype-editor:onChange");}else{if(g==="reset"){this._resetSelection(true);e.Bewype.Utils.setCssDict(f,this._oMainCssdict);return e.fire("bewype-editor:onChange");}}}if(h){j=this._getWorkingTagName(g,true);if(j){this._removeTag(h,j,g);}j=this._getWorkingTagName(g);if(o&&(o===true||o.trim()!=="")){if(g==="url"){l=e.Node.create('<a href="'+o+'"></a>');}else{l=e.Node.create("<"+j+"></"+j+">");}if(this._cssButtons.indexOf(g)!=-1){l.setStyle(e.Bewype.Utils.camelize(g),o);if(g==="background-color"){l.setStyle("display","inline-block");}}n=e.Node.create('<span class="selection"></span>');
n.append(l);n.one(j).append(this._getInnerHTML(h));h.replace(n);}else{if(g==="reset"){this._resetSelection();this._refreshButtons(true);}}this._refreshSelectionNode();e.fire("bewype-editor:onChange");}},_onButtonEventClick:function(f,h){var g=this.get("activeButtons");e.Object.each(this._pickerButtons,function(j,i){if(g.indexOf(j)!=-1&&j!=f){this._buttonDict[j].hidePicker();}},this);this._refreshButtons(false,f);},_updateSpinnerMaxWidth:function(){var k=this.get("spinnerMaxWidth"),i=this._buttonDict["padding-left"],g=this._buttonDict["width"],h=i?i.getValue():0,l=g?g.getValue():0,f=g?k-l:k,j=i?k-h:k;if(i){i.set("max",f);}if(g){g.set("max",j);}return{"padding-left":f,"width":j};},_onSpinnerEventChange:function(f,o){var m=this.get("host"),j=this.get("editorClass")+"-place",q=m.one("."+j),n=this._buttonDict[f],l=e.Bewype.Utils.getCssDict(m),i=l[f],g=i?parseInt(i.replace(/px/i,""),10):0,h=n.getValue(),k=(f=="padding-left")?h/2:h,p=this._updateSpinnerMaxWidth();if(p[f]&&k>p[f]){n.setValue(g);}else{q.setStyle(e.Bewype.Utils.camelize(f),h+"px");e.fire("bewype-editor:onChange");}}});e.augment(c,e.EventTarget);e.namespace("Bewype");e.Bewype.Editor=c;},"@VERSION@",{requires:["bewype-button","bewype-entry-spinner","bewype-utils","dataschema","editor","event-custom","json-stringify","plugin","stylesheet"]});