YUI.add("bewype-editor",function(E){var D="",B="",A="",C=null;D+='<div class="{editorClass}-place">';D+="</div>";B+='<div class="{editorClass} {buttonClass}">';B+="</div>";A+='<div class="{editorClass}">';A+="{label}";A+='<div class="{spinnerClass}"></div>';A+="</div>";C=function(F){C.superclass.constructor.apply(this,arguments);};C.NAME="bewype-editor";C.NS="bewypeEditor";C.ATTRS={editorClass:{value:"yui3-bewype-editor",writeOnce:true,validator:function(F){return E.Lang.isString(F);}},activeButtons:{value:["height","width","bold","italic","underline","font-family","font-size","color","background-color","url","reset"],writeOnce:true},panelNode:{value:null,writeOnce:true},selectionColor:{value:"#ddd",writeOnce:true,validator:function(F){return E.Lang.isString(F);}},spinnerLabelHeight:{value:"height",writeOnce:true,validator:function(F){return E.Lang.isString(F);}},spinnerLabelWidth:{value:"width",writeOnce:true,validator:function(F){return E.Lang.isString(F);}},spinnerMaxHeight:{value:480,writeOnce:true,validator:function(F){return E.Lang.isNumber(F);}},spinnerMaxWidth:{value:640,writeOnce:true,validator:function(F){return E.Lang.isNumber(F);}}};E.extend(C,E.Plugin.Base,{_editor:null,_buttonDict:{},_spinnerButtons:["height","width"],_spinnerValues:{},_toggleButtons:["bold","italic","underline"],_pickerButtons:["font-family","font-size","color","background-color","url"],_pickerObjDict:{"font-family":E.Bewype.PickerFontFamily,"font-size":E.Bewype.PickerFontSize,"color":E.Bewype.PickerColor,"background-color":E.Bewype.PickerColor,"url":E.Bewype.PickerUrl},_tagButtons:["bold","italic","underline","url"],_cssButtons:["font-family","font-size","color","background-color"],_selectedNodeList:null,_oMainCssdict:{},_initEditor:function(){var G=this.get("host"),H=this.get("editorClass"),F=E.Bewype.Utils.getCssDict(G),J=null,I=new E.Node.create('<div><div class="main" /></div>');I.one(".main").append(this._getInnerHTML(G));G.set("innerHTML","");J=new E.Node.create(E.substitute(D,{editorClass:H}));G.append(J);this._editor=new E.EditorBase({content:I.get("innerHTML")});this._editor.render(J);this._editor.after("nodeChange",E.bind(this._onEditorChange,this));return F;},_initContent:function(G){var F=this.get("host"),H=this.get("editorClass")+"-place",L=F.one("."+H),J=this._editor.getInstance().one("body"),I=J.one(".main"),K=null;J.setStyle("cssText","padding: 0; margin: 0; height: 100%; width: 100%;");K=function(N,Q){var R=["height","width"].indexOf(N)!=-1,P=N.split("-"),O=P.indexOf("border")!=-1,M=P.indexOf("padding")!=-1;if(R||O||M){L.setStyle(E.Bewype.Utils.camelize(N),Q);this._spinnerValues[N]=Q;}else{if(N){I.setStyle(E.Bewype.Utils.camelize(N),Q);}}return Q;};this._oMainCssdict.height="100%";this._oMainCssdict.width="100%";I.setStyle("height","100%");I.setStyle("width","100%");E.JSON.stringify(G,E.bind(K,this));F.setStyle("cssText","");},_addSpinnerButton:function(J){var I=this.get("panelNode"),L=this.get("editorClass")+"-button",H=this.get("editorClass")+"-spinner-"+J,F=null,K=null,G=this._spinnerValues[J];F=new E.Node.create(E.substitute(A,{editorClass:L,label:this.get(E.Bewype.Utils.camelize("spinner-label-"+J)),spinnerClass:H}));I.append(F);K=new E.Bewype.EntrySpinner({srcNode:F.one("."+H),max:this.get(E.Bewype.Utils.camelize("spinner-max-"+J)),min:0,value:(G)?parseInt(G.replace(/px/i,""),10):0});K.render();K.on("entry:onChange",E.bind(this._onSpinnerEventChange,this,J));this._buttonDict[J]=K;},_onSpinnerEventChange:function(H,F){var I=this.get("host"),J=this.get("editorClass")+"-place",K=I.one("."+J),G=this._buttonDict[H].getValue();K.setStyle(E.Bewype.Utils.camelize(H),G+"px");},__buttonFactory:function(I,G,K){var H=this.get("panelNode"),L=this.get("editorClass"),M=null,F=null,J=null;M=new E.Node.create(E.substitute(B,{editorClass:L+"-button",buttonClass:L+"-button-"+I}));H.append(M);K.render(M);if(G==="button"){F="button:onClick";}else{F="button:onChange";}K.on(F,E.bind(this._onButtonEventChange,this,I));if(this._pickerButtons.indexOf(I)!=-1){J="button:onClick";K.before(J,E.bind(this._onButtonEventClick,this,I));}this._buttonDict[I]=K;},_addButton:function(F){var G=new E.Bewype.Button({label:F});this.__buttonFactory(F,"button",G);},_addToggleButton:function(F){var G=new E.Bewype.ButtonToggle({label:F});this.__buttonFactory(F,"toggle-button",G);},_addPickerButton:function(F,H){var G=new E.Bewype.ButtonPicker({label:F,pickerObj:H});this.__buttonFactory(F,"picker-button",G);},_initPanel:function(){var F=this.get("activeButtons");E.Object.each(this._spinnerButtons,function(H,G){if(F.indexOf(H)!=-1){this._addSpinnerButton(H);}},this);E.Object.each(this._toggleButtons,function(H,G){if(F.indexOf(H)!=-1){this._addToggleButton(H);}},this);E.Object.each(this._pickerButtons,function(H,G){if(F.indexOf(H)!=-1){this._addPickerButton(H,this._pickerObjDict[H]);}},this);this._addButton("reset");},initializer:function(G){var F=this._initEditor();this._initContent(F);this._initPanel();},destructor:function(){if(!this._editor){return;}var L=this.get("host"),M=this.get("panelNode"),K=this.get("editorClass"),I="."+K+"-place",N=L.one(I),H=this._editor.getInstance().one("body"),F=H.one(".main"),G=F.one(".selection"),J=null;this._editor.hide();if(G){G.replace(this._getInnerHTML(G));}L.set("innerHTML",F.get("innerHTML"));J=function(O,P,Q){if(P){if(O==="content"&&(P.split("-").indexOf("padding")!=-1||P==="height"||P==="width")){}else{L.setStyle(E.Bewype.Utils.camelize(P),Q);}}return Q;};E.JSON.stringify(E.Bewype.Utils.getCssDict(N),E.bind(J,this,"place"));E.JSON.stringify(E.Bewype.Utils.getCssDict(F),E.bind(J,this,"content"));this._editor.destroy();E.Object.each(this.get("activeButtons"),function(P,O){this._buttonDict[P].destroy();delete (this._buttonDict[P]);},this);M.all("."+K+"-button").each(function(P,O){P.remove();});},_hasLeftBlank:function(F){if(F.length===0){return false;}else{if(F.substring(0,1).trim().length===0){return true;}}return false;},_hasRightBlank:function(F){if(F.length===0){return false;}else{if(F.substring(F.length-1,F.length).trim().length===0){return true;
}}return false;},_getInnerHTML:function(I,G){var H=I._node?I._node:I,F=H.innerHTML,J="";J+=this._hasLeftBlank(F)?"&nbsp;":"";J+=F.trim();J+=this._hasRightBlank(F)?"&nbsp;":"";return G?J:J.trim()===""?null:new E.Node.create(J);},_getWorkingTagName:function(F){switch(F){case"bold":return"b";case"italic":return"i";case"underline":return"u";case"url":return"a";default:return"span";}},_removeTag:function(G,F,H){if(G&&G._node.innerHTML){G.all(F).each(function(K,J){var L=null,I=null,M=null;if(H){L=E.Bewype.Utils.getCssDict(K);if(L[H]){delete (L[H]);if(H==="background-color"){delete (L.display);}}E.Bewype.Utils.setCssDict(K,L);M=E.Object.keys(L).length;if(M!==0){return;}}I=this._getInnerHTML(K);if(!I){K.remove();}else{K.replace(this._getInnerHTML(K));}},this);}},_updateMainStyle:function(H,K){var J=this.get("host"),M=["height","width"].indexOf(H)!=-1,L=H.split("-"),F=L.indexOf("padding")!=-1,I=K?K:null,G=this._buttonDict[H].getValue();if(!I){if(M||F){I=J.one("."+this.get("editorClass")+"-place");}else{I=this._editor.getInstance().one(".main");}}I.setStyle(E.Bewype.Utils.camelize(H),G);},_clearSelection:function(I,G,F){if(I.clear){I.clear();}else{if(I.removeAllRanges){G.detach();I.removeAllRanges();}else{return;}}if(F!==false){var H=this._editor.getInstance(),J=H.one("body").one(".main");this._removeTag(J,".selection");}},_isFocusNodeFisrt:function(O){var H=this._editor.getInstance(),K=H.one("body").one(".main")._node,L=O.anchorNode,Q=O.focusNode,G=O.anchorOffset,P=O.focusOffset,M=K.innerHTML?K.innerHTML:K.textContent,N=L.innerHTML?L.innerHTML:L.textContent,F=Q.innerHTML?Q.innerHTML:Q.textContent,J=0,I=0;if(L==Q){return P<G;}else{J=M.indexOf(N);I=M.indexOf(F);return I<J;}},_ensureRangeFirstNode:function(I,F,L){var H=this._editor.getInstance(),M=H.one("body").one(".main"),G=M._node,K=0;if(L.parentNode!=G){try{while(L.parentNode&&L.parentNode!=G){L=L.parentNode;K+=1;if(K==10){break;}}F.setStartBefore(L);}catch(J){return this._clearSelection(I,F);}}else{if(I.anchorOffset===0&&!I.anchorNode.previousSibling){F.setStart(G,0);}}return true;},_ensureRangeLastNode:function(I,F,L){var H=this._editor.getInstance(),M=H.one("body").one(".main"),G=M._node,K=0;if(L.parentNode!=G){try{while(L.parentNode&&L.parentNode!=G){L=L.parentNode;K+=1;if(K==10){break;}}F.setEndAfter(L);}catch(J){return this._clearSelection(I,F);}}return true;},_refreshSelectionNode:function(){var F=this._editor.getInstance(),G=F.one("body").one(".selection"),H=this.get("selectionColor");if(!G){return;}G.setStyle("backgroundColor",H);G.setStyle("display","inline-block");},_updateSelection:function(){var M=this.get("host"),I=this._editor.getInstance(),J=I.one("body"),F=J.one(".main"),H=F.one(".selection"),N=E.Bewype.Utils.getSelection(M),L=E.Bewype.Utils.getRange(N),O=null,G=null;if(!N.anchorNode||!N.focusNode){return this._clearSelection(N,L);}if(H){H.replace(this._getInnerHTML(H));}if(N.anchorNode!=N.focusNode||N.anchorOffset!=N.focusOffset){if(this._isFocusNodeFisrt(N)){O=N.focusNode;G=N.anchorNode;}else{O=N.anchorNode;G=N.focusNode;}if(!this._ensureRangeFirstNode(N,L,O)){return;}if(!this._ensureRangeLastNode(N,L,G)){return;}try{H=E.Node.create('<span class="selection"></span>');F.append(H);L.surroundContents(F.one(".selection")._node);}catch(K){return this._clearSelection(N,L);}this._clearSelection(N,L,false);}else{this._removeTag(F,".selection");}this._refreshButtons();this._refreshSelectionNode();},_onEditorChange:function(F){if(F.changedEvent.type=="dblclick"){}else{if(F.changedEvent.type=="mouseup"){this._updateSelection();}}},_resetSelection:function(F){var H=this._editor.getInstance(),I=H.one("body"),G=F?I.one(".main"):I.one(".selection");if(!G){return;}this._removeTag(G,"span");this._removeTag(G,"a");this._removeTag(G,"b");this._removeTag(G,"i");this._removeTag(G,"u");},_getValueFromNode:function(F,J,H){var I=F?F.one(J):null,G=null;if(I){if(H==="url"){return I.get("href");}else{G=E.Bewype.Utils.getCssDict(I);return G[H];}}return null;},_refreshButtons:function(I,F){var G=this._editor.getInstance(),H=G.one("body").one(".selection"),J=F?[F]:this._toggleButtons;if(!H){I=true;}E.Object.each(J,function(M,L){if(this.get("activeButtons").indexOf(M)===-1){return;}var K=null;switch(M){case"bold":K=I?false:(H&&H.one("b")!==null);return this._buttonDict[M].setValue(K);case"italic":K=I?false:(H&&H.one("i")!==null);return this._buttonDict[M].setValue(K);case"underline":K=I?false:(H&&H.one("u")!==null);return this._buttonDict[M].setValue(K);case"font-family":case"font-size":case"color":case"background-color":K=I?false:this._getValueFromNode(H,"span",M);return this._buttonDict[M].setValue(K);case"url":K=I?false:this._getValueFromNode(H,"a",M);return this._buttonDict[M].setValue(K);}},this);},_onButtonEventChange:function(G,M){var I=this._editor.getInstance(),K=I.one("body"),F=K.one(".main"),H=F.one(".selection"),O=this._buttonDict[G].getValue(),J=null,L=null,N=null;if(!H){if(this._cssButtons.indexOf(G)!=-1){return this._updateMainStyle(G);}else{if(G==="reset"){this._resetSelection(true);return E.Bewype.Utils.setCssDict(F,this._oMainCssdict);}}}if(H){J=this._getWorkingTagName(G);this._removeTag(H,J,G);if(O&&(O===true||O.trim()!=="")){if(G==="url"){L=E.Node.create('<a href="'+O+'"></a>');}else{L=E.Node.create("<"+J+"></"+J+">");}if(this._cssButtons.indexOf(G)!=-1){L.setStyle(E.Bewype.Utils.camelize(G),O);if(G==="background-color"){L.setStyle("display","inline-block");}}N=E.Node.create('<span class="selection"></span>');N.append(L);N.one(J).append(this._getInnerHTML(H));H.replace(N);}else{if(G==="reset"){this._resetSelection();this._refreshButtons(true);}}this._refreshSelectionNode();}},_onButtonEventClick:function(F,G){this._refreshButtons(false,F);}});E.namespace("Bewype");E.Bewype.Editor=C;},"@VERSION@",{requires:["bewype-button","bewype-entry-spinner","bewype-utils","dataschema","editor","json-stringify","plugin","stylesheet"]});