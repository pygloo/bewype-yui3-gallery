YUI.add("bewype-editor",function(d){var c="",a="",b=null;c+='<div class="{editorClass}-place">';c+="</div>";a+='<div class="{editorClass} {buttonClass}">';a+="</div>";b=function(e){b.superclass.constructor.apply(this,arguments);};b.NAME="bewypeEditor";b.NS="bewypeEditor";b.ATTRS={editorClass:{value:"yui3-bewype-editor",writeOnce:true,validator:function(e){return d.Lang.isString(e);}},activeButtons:{value:["bold","italic","underline","font-family","font-size","color","background-color","url","reset"],writeOnce:true},panelNode:{value:null,writeOnce:true},selectionColor:{value:"#ddd",writeOnce:true,validator:function(e){return d.Lang.isString(e);}}};d.extend(b,d.Plugin.Base,{_editor:null,_buttonDict:{},_toggleButtons:["bold","italic","underline"],_pickerButtons:["font-family","font-size","color","background-color","url"],_pickerObjDict:{"font-family":d.Bewype.PickerFontFamily,"font-size":d.Bewype.PickerFontSize,"color":d.Bewype.PickerColor,"background-color":d.Bewype.PickerColor,"url":d.Bewype.PickerUrl},_tagButtons:["bold","italic","underline","url"],_cssButtons:["font-family","font-size","color","background-color"],_selectedNodeList:null,_oMainCssdict:{},_initEditor:function(){var f=this.get("host"),g=this.get("editorClass"),e=d.Bewype.Utils.getCssDict(f),i=null,h=new d.Node.create('<div><div class="main" /></div>');h.one(".main").append(this._getInnerHTML(f));f.set("innerHTML","");i=new d.Node.create(d.substitute(c,{editorClass:g}));f.append(i);this._editor=new d.EditorBase({content:h.get("innerHTML")});this._editor.render(i);this._editor.after("nodeChange",d.bind(this._onEditorChange,this));return e;},_initContent:function(f){var e=this.get("host"),g=this.get("editorClass")+"-place",k=e.one("."+g),i=this._editor.getInstance().one("body"),h=i.one(".main"),j=null;i.setStyle("cssText","padding: 0; margin: 0; height: 100%; width: 100%;");j=function(m,p){var q=["height","width"].indexOf(m)!=-1,o=m.split("-"),n=o.indexOf("border")!=-1,l=o.indexOf("padding")!=-1;if(q||n||l){k.setStyle(d.Bewype.Utils.camelize(m),p);}else{if(m){h.setStyle(d.Bewype.Utils.camelize(m),p);}}return p;};this._oMainCssdict.height="100%";this._oMainCssdict.width="100%";h.setStyle("height","100%");h.setStyle("width","100%");d.JSON.stringify(f,d.bind(j,this));e.setStyle("cssText","");},__buttonFactory:function(h,f,j){var g=this.get("panelNode"),k=this.get("editorClass"),l=null,e=null,i=null;l=new d.Node.create(d.substitute(a,{editorClass:k+"-button",buttonClass:k+"-"+f+"-"+h}));g.append(l);j.render(l);if(f==="button"){e="button:onClick";}else{e="button:onChange";}j.on(e,d.bind(this._onButtonEventChange,this,h));if(this._pickerButtons.indexOf(h)!=-1){i="button:onClick";j.before(i,d.bind(this._onButtonEventClick,this,h));}this._buttonDict[h]=j;},_addButton:function(e){var f=new d.Bewype.Button({label:e});this.__buttonFactory(e,"button",f);},_addToggleButton:function(e){var f=new d.Bewype.ButtonToggle({label:e});this.__buttonFactory(e,"toggle-button",f);},_addPickerButton:function(e,g){var f=new d.Bewype.ButtonPicker({label:e,pickerObj:g});this.__buttonFactory(e,"picker-button",f);},_initPanel:function(){var e=this.get("activeButtons");d.Object.each(this._toggleButtons,function(g,f){if(e.indexOf(g)!=-1){this._addToggleButton(g);}},this);d.Object.each(this._pickerButtons,function(g,f){if(e.indexOf(g)!=-1){this._addPickerButton(g,this._pickerObjDict[g]);}},this);this._addButton("reset");},initializer:function(f){var e=this._initEditor();this._initContent(e);this._initPanel();},destructor:function(){if(!this._editor){return;}var e=this.get("host"),h=this.get("editorClass"),g="."+h+"-place",l=e.one(g),j=this._editor.getInstance().one("body"),i=j.one(".main"),f=i.one(".selection"),k=null;this._editor.hide();if(f){f.replace(this._getInnerHTML(f));}e.set("innerHTML",i.get("innerHTML"));k=function(m,n,o){if(n){if(m==="content"&&(n.split("-").indexOf("padding")!=-1||n==="height"||n==="width")){}else{e.setStyle(d.Bewype.Utils.camelize(n),o);}}return o;};d.JSON.stringify(d.Bewype.Utils.getCssDict(l),d.bind(k,this,"place"));d.JSON.stringify(d.Bewype.Utils.getCssDict(i),d.bind(k,this,"content"));this._editor.destroy();d.Object.each(this.get("activeButtons"),function(n,m){this._buttonDict[n].destroy();delete (this._buttonDict[n]);},this);this._buttonDict={};},_hasLeftBlank:function(e){if(e.length===0){return false;}else{if(e.substring(0,1).trim().length===0){return true;}}return false;},_hasRightBlank:function(e){if(e.length===0){return false;}else{if(e.substring(e.length-1,e.length).trim().length===0){return true;}}return false;},_getInnerHTML:function(h,f){var g=h._node?h._node:h,e=g.innerHTML,i="";i+=this._hasLeftBlank(e)?"&nbsp;":"";i+=e.trim();i+=this._hasRightBlank(e)?"&nbsp;":"";return f?i:i.trim()===""?null:new d.Node.create(i);},_getWorkingTagName:function(e){switch(e){case"bold":return"b";case"italic":return"i";case"underline":return"u";case"url":return"a";default:return"span";}},_removeTag:function(f,e,g){if(f&&f._node.innerHTML){f.all(e).each(function(j,i){var l=null,h=null,m=null;if(g){l=d.Bewype.Utils.getCssDict(j);if(l[g]){delete (l[g]);if(g==="background-color"){delete (l.display);}}d.Bewype.Utils.setCssDict(j,l);m=d.Object.keys(l).length;if(m!==0){return;}}h=this._getInnerHTML(j);if(!h){j.remove();}else{j.replace(this._getInnerHTML(j));}},this);}},_updateMainStyle:function(g,j){var i=this.get("host"),l=["height","width"].indexOf(g)!=-1,k=g.split("-"),e=k.indexOf("padding")!=-1,h=j?j:null,f=this._buttonDict[g].getValue();if(!h){if(l||e){h=i.one("."+this.get("editorClass")+"-place");}else{h=this._editor.getInstance().one(".main");}}h.setStyle(d.Bewype.Utils.camelize(g),f);},_clearSelection:function(h,f,e){if(h.clear){h.clear();}else{if(h.removeAllRanges){f.detach();h.removeAllRanges();}else{return;}}if(e!==false){var g=this._editor.getInstance(),i=g.one("body").one(".main");this._removeTag(i,".selection");}},_isFocusNodeFisrt:function(n){var g=this._editor.getInstance(),j=g.one("body").one(".main")._node,k=n.anchorNode,p=n.focusNode,f=n.anchorOffset,o=n.focusOffset,l=j.innerHTML?j.innerHTML:j.textContent,m=k.innerHTML?k.innerHTML:k.textContent,e=p.innerHTML?p.innerHTML:p.textContent,i=0,h=0;
if(k==p){return o<f;}else{i=l.indexOf(m);h=l.indexOf(e);return h<i;}},_ensureRangeFirstNode:function(h,e,k){var g=this._editor.getInstance(),l=g.one("body").one(".main"),f=l._node,j=0;if(k.parentNode!=f){try{while(k.parentNode&&k.parentNode!=f){k=k.parentNode;j+=1;if(j==10){break;}}e.setStartBefore(k);}catch(i){return this._clearSelection(h,e);}}else{if(h.anchorOffset===0&&!h.anchorNode.previousSibling){e.setStart(f,0);}}return true;},_ensureRangeLastNode:function(h,e,k){var g=this._editor.getInstance(),l=g.one("body").one(".main"),f=l._node,j=0;if(k.parentNode!=f){try{while(k.parentNode&&k.parentNode!=f){k=k.parentNode;j+=1;if(j==10){break;}}e.setEndAfter(k);}catch(i){return this._clearSelection(h,e);}}return true;},_refreshSelectionNode:function(){var e=this._editor.getInstance(),f=e.one("body").one(".selection"),g=this.get("selectionColor");if(!f){return;}f.setStyle("backgroundColor",g);f.setStyle("display","inline-block");},_updateSelection:function(){var l=this.get("host"),h=this._editor.getInstance(),i=h.one("body"),e=i.one(".main"),g=e.one(".selection"),m=d.Bewype.Utils.getSelection(l),k=d.Bewype.Utils.getRange(m),n=null,f=null;if(!m.anchorNode||!m.focusNode){return this._clearSelection(m,k);}if(g){g.replace(this._getInnerHTML(g));}if(m.anchorNode!=m.focusNode||m.anchorOffset!=m.focusOffset){if(this._isFocusNodeFisrt(m)){n=m.focusNode;f=m.anchorNode;}else{n=m.anchorNode;f=m.focusNode;}if(!this._ensureRangeFirstNode(m,k,n)){return;}if(!this._ensureRangeLastNode(m,k,f)){return;}try{g=d.Node.create('<span class="selection"></span>');e.append(g);k.surroundContents(e.one(".selection")._node);}catch(j){return this._clearSelection(m,k);}this._clearSelection(m,k,false);}else{this._removeTag(e,".selection");}this._refreshButtons();this._refreshSelectionNode();},_onEditorChange:function(f){if(f.changedEvent.type=="dblclick"){}else{if(f.changedEvent.type=="mouseup"){this._updateSelection();}}},_resetSelection:function(e){var g=this._editor.getInstance(),h=g.one("body"),f=e?h.one(".main"):h.one(".selection");if(!f){return;}this._removeTag(f,"span");this._removeTag(f,"a");this._removeTag(f,"b");this._removeTag(f,"i");this._removeTag(f,"u");},_getValueFromNode:function(e,i,g){var h=e?e.one(i):null,f=null;if(h){if(g==="url"){return h.get("href");}else{f=d.Bewype.Utils.getCssDict(h);return f[g];}}return null;},_refreshButtons:function(h,e){var f=this._editor.getInstance(),g=f.one("body").one(".selection"),i=e?[e]:this._toggleButtons;if(!g){h=true;}d.Object.each(i,function(m,l){if(this.get("activeButtons").indexOf(m)===-1){return;}var j=null;switch(m){case"bold":j=h?false:(g&&g.one("b")!==null);return this._buttonDict[m].setValue(j);case"italic":j=h?false:(g&&g.one("i")!==null);return this._buttonDict[m].setValue(j);case"underline":j=h?false:(g&&g.one("u")!==null);return this._buttonDict[m].setValue(j);case"font-family":case"font-size":case"color":case"background-color":j=h?false:this._getValueFromNode(g,"span",m);return this._buttonDict[m].setValue(j);case"url":j=h?false:this._getValueFromNode(g,"a",m);return this._buttonDict[m].setValue(j);}},this);},_onButtonEventChange:function(g,m){var i=this._editor.getInstance(),k=i.one("body"),f=k.one(".main"),h=f.one(".selection"),o=this._buttonDict[g].getValue(),j=null,l=null,n=null;if(!h){if(this._cssButtons.indexOf(g)!=-1){return this._updateMainStyle(g);}else{if(g==="reset"){this._resetSelection(true);return d.Bewype.Utils.setCssDict(f,this._oMainCssdict);}}}if(h){j=this._getWorkingTagName(g);this._removeTag(h,j,g);if(o&&(o===true||o.trim()!=="")){if(g==="url"){l=d.Node.create('<a href="'+o+'"></a>');}else{l=d.Node.create("<"+j+"></"+j+">");}if(this._cssButtons.indexOf(g)!=-1){l.setStyle(d.Bewype.Utils.camelize(g),o);if(g==="background-color"){l.setStyle("display","inline-block");}}n=d.Node.create('<span class="selection"></span>');n.append(l);n.one(j).append(this._getInnerHTML(h));h.replace(n);}else{if(g==="reset"){this._resetSelection();this._refreshButtons(true);}}this._refreshSelectionNode();}},_onButtonEventClick:function(f,g){this._refreshButtons(false,f);}});d.namespace("Bewype");d.Bewype.Editor=b;},"@VERSION@",{requires:["bewype-button","bewype-utils","dataschema","editor","json-stringify","plugin","stylesheet"]});