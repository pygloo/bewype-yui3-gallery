YUI.add("bewype-editor",function(D){var C="",A="",B=null;C+='<div class="{editorClass}-place">';C+="</div>";A+='<div class="{editorClass}">';A+="</div>";B=function(E){B.superclass.constructor.apply(this,arguments);};B.NAME="bewypeEditor";B.NS="bewypeEditor";B.ATTRS={editorClass:{value:"yui3-bewype-editor",writeOnce:true,validator:function(E){return D.Lang.isString(E);}},activeButtons:{value:["reset","bold","italic","underline","font-family","font-size","color","background-color"],writeOnce:true},panelNode:{value:null,writeOnce:true},selectionColor:{value:"#ddd",writeOnce:true,validator:function(E){return D.Lang.isString(E);}}};D.extend(B,D.Plugin.Base,{_editor:null,_buttonDict:{},_toggleButtons:["bold","italic","underline"],_pickerButtons:["font-family","font-size","color","background-color"],_pickerObjDict:{"font-family":D.Bewype.PickerFontFamily,"font-size":D.Bewype.PickerFontSize,"color":D.Bewype.PickerColor,"background-color":D.Bewype.PickerColor},_tagButtons:["bold","italic","underline"],_cssButtons:["font-family","font-size","color","background-color"],_selectedNodeList:null,_oMainCssdict:{},_initEditor:function(){var F=this.get("host"),G=this.get("editorClass"),E=D.Bewype.Utils.getCssDict(F),I=null,H=new D.Node.create('<div><div class="main" /></div>');H.one(".main").append(this._getInnerHTML(F));F.set("innerHTML","");I=new D.Node.create(D.substitute(C,{editorClass:G}));F.append(I);this._editor=new D.EditorBase({content:H.get("innerHTML")});this._editor.render(I);this._editor.after("nodeChange",D.bind(this._onEditorChange,this));return E;},_initContent:function(F){var E=this.get("host"),G=this.get("editorClass")+"-place",K=E.one("."+G),I=this._editor.getInstance().one("body"),H=I.one(".main"),J=null;I.setStyle("cssText","padding: 0; margin: 0; height: 100%; width: 100%;");J=function(M,P){var Q=["height","width"].indexOf(M)!=-1,O=M.split("-"),N=O.indexOf("border")!=-1,L=O.indexOf("padding")!=-1;if(Q||N||L){K.setStyle(D.Bewype.Utils.camelize(M),P);}else{if(M){H.setStyle(D.Bewype.Utils.camelize(M),P);}}return P;};this._oMainCssdict.height="100%";this._oMainCssdict.width="100%";H.setStyle("height","100%");H.setStyle("width","100%");D.JSON.stringify(F,D.bind(J,this));E.setStyle("cssText","");},__buttonFactory:function(G,E,H){var F=this.get("panelNode"),I=this.get("editorClass"),K=null,J=null;K=new D.Node.create(D.substitute(A,{editorClass:I+"-"+E+"-"+G}));F.append(K);H.render(K);if(E==="button"){J="button:onClick";}else{J="button:onChange";}H.on(J,D.bind(this._onButtonEvent,this,G));this._buttonDict[G]=H;},_addButton:function(E){var F=new D.Bewype.Button({label:E});this.__buttonFactory(E,"button",F);},_addToggleButton:function(E){var F=new D.Bewype.ButtonToggle({label:E});this.__buttonFactory(E,"toggle-button",F);},_addPickerButton:function(E,G){var F=new D.Bewype.ButtonPicker({label:E,pickerObj:G});this.__buttonFactory(E,"picker-button",F);},_initPanel:function(){this._addButton("reset");var E=this.get("activeButtons");D.Object.each(this._toggleButtons,function(G,F){if(E.indexOf(G)!=-1){this._addToggleButton(G);}},this);D.Object.each(this._pickerButtons,function(G,F){if(E.indexOf(G)!=-1){this._addPickerButton(G,this._pickerObjDict[G]);}},this);},initializer:function(F){var E=this._initEditor();this._initContent(E);this._initPanel();},destructor:function(){if(!this._editor){return;}var E=this.get("host"),H=this.get("editorClass"),G="."+H+"-place",L=E.one(G),J=this._editor.getInstance().one("body"),I=J.one(".main"),F=I.one(".selection"),K=null;this._editor.hide();if(F){F.replace(this._getInnerHTML(F));}E.set("innerHTML",I.get("innerHTML"));K=function(M,N,O){if(N){if(M==="content"&&(N.split("-").indexOf("padding")!=-1||N==="height"||N==="width")){}else{E.setStyle(D.Bewype.Utils.camelize(N),O);}}return O;};D.JSON.stringify(D.Bewype.Utils.getCssDict(L),D.bind(K,this,"place"));D.JSON.stringify(D.Bewype.Utils.getCssDict(I),D.bind(K,this,"content"));this._editor.destroy();D.Object.each(this.get("activeButtons"),function(N,M){this._buttonDict[N].destroy();delete (this._buttonDict[N]);},this);this._buttonDict={};},_hasLeftBlank:function(E){if(E.length===0){return false;}else{if(E.substring(0,1).trim().length===0){return true;}}return false;},_hasRightBlank:function(E){if(E.length===0){return false;}else{if(E.substring(E.length-1,E.length).trim().length===0){return true;}}return false;},_getInnerHTML:function(H,F){var G=H._node?H._node:H,E=G.innerHTML,I="";I+=this._hasLeftBlank(E)?"&nbsp;":"";I+=E.trim();I+=this._hasRightBlank(E)?"&nbsp;":"";return F?I:I.trim()===""?null:new D.Node.create(I);},_getWorkingTagName:function(E){switch(E){case"bold":return"b";case"italic":return"i";case"underline":return"u";default:return"span";}},_removeTag:function(F,E,G){if(F&&F._node.innerHTML){F.all(E).each(function(J,I){var K=null,H=null,L=null;if(G){K=D.Bewype.Utils.getCssDict(J);if(K[G]){delete (K[G]);if(G==="background-color"){delete (K.display);}}D.Bewype.Utils.setCssDict(J,K);L=D.Object.keys(K).length;if(L!==0){return;}}H=this._getInnerHTML(J);if(!H){J.remove();}else{J.replace(this._getInnerHTML(J));}},this);}},_updateMainStyle:function(G,J){var I=this.get("host"),L=["height","width"].indexOf(G)!=-1,K=G.split("-"),E=K.indexOf("padding")!=-1,H=J?J:null,F=this._buttonDict[G].getValue();if(!H){if(L||E){H=I.one("."+this.get("editorClass")+"-place");}else{H=this._editor.getInstance().one(".main");}}H.setStyle(D.Bewype.Utils.camelize(G),F);},_clearSelection:function(H,F,E){if(H.clear){H.clear();}else{if(H.removeAllRanges){F.detach();H.removeAllRanges();}else{return;}}if(E!==false){var G=this._editor.getInstance(),I=G.one("body").one(".main");this._removeTag(I,".selection");}},_isFocusNodeFisrt:function(N){var G=this._editor.getInstance(),J=G.one("body").one(".main")._node,K=N.anchorNode,P=N.focusNode,F=N.anchorOffset,O=N.focusOffset,L=J.innerHTML?J.innerHTML:J.textContent,M=K.innerHTML?K.innerHTML:K.textContent,E=P.innerHTML?P.innerHTML:P.textContent,I=0,H=0;if(K==P){return O<F;}else{I=L.indexOf(M);H=L.indexOf(E);
return H<I;}},_ensureRangeFirstNode:function(H,E,K){var G=this._editor.getInstance(),L=G.one("body").one(".main"),F=L._node,J=0;if(K.parentNode!=F){try{while(K.parentNode&&K.parentNode!=F){K=K.parentNode;J+=1;if(J==10){break;}}E.setStartBefore(K);}catch(I){return this._clearSelection(H,E);}}else{if(H.anchorOffset===0&&!H.anchorNode.previousSibling){E.setStart(F,0);}}return true;},_ensureRangeLastNode:function(H,E,K){var G=this._editor.getInstance(),L=G.one("body").one(".main"),F=L._node,J=0;if(K.parentNode!=F){try{while(K.parentNode&&K.parentNode!=F){K=K.parentNode;J+=1;if(J==10){break;}}E.setEndAfter(K);}catch(I){return this._clearSelection(H,E);}}return true;},_refreshSelectionNode:function(){var E=this._editor.getInstance(),F=E.one("body").one(".selection"),G=this.get("selectionColor");if(!F){return;}F.setStyle("backgroundColor",G);F.setStyle("display","inline-block");},_updateSelection:function(){var L=this.get("host"),H=this._editor.getInstance(),I=H.one("body"),E=I.one(".main"),G=E.one(".selection"),M=D.Bewype.Utils.getSelection(L),K=D.Bewype.Utils.getRange(M),N=null,F=null;if(!M.anchorNode||!M.focusNode){return this._clearSelection(M,K);}if(G){G.replace(this._getInnerHTML(G));}if(M.anchorNode!=M.focusNode||M.anchorOffset!=M.focusOffset){if(this._isFocusNodeFisrt(M)){N=M.focusNode;F=M.anchorNode;}else{N=M.anchorNode;F=M.focusNode;}if(!this._ensureRangeFirstNode(M,K,N)){return;}if(!this._ensureRangeLastNode(M,K,F)){return;}try{G=D.Node.create('<span class="selection"></span>');E.append(G);K.surroundContents(E.one(".selection")._node);}catch(J){return this._clearSelection(M,K);}this._clearSelection(M,K,false);}else{this._removeTag(E,".selection");}this._refreshButtons();this._refreshSelectionNode();},_onEditorChange:function(E){if(E.changedEvent.type=="dblclick"){}else{if(E.changedEvent.type=="mouseup"){this._updateSelection();}}},_getAncestor:function(F){var E=F;D.each(["span","a","b","i","u"],function(H,G){var I=F.ancestor("v");if(I&&I.get("textContent")===F.get("ancestor")){E=I;}});return E;},_resetSelection:function(E){var G=this._editor.getInstance(),H=G.one("body"),F=E?H.one(".main"):H.one(".selection");if(!F){return;}F=this._getAncestor(F);this._removeTag(F,"span");this._removeTag(F,"b");this._removeTag(F,"i");this._removeTag(F,"u");},_refreshButtons:function(G){var E=this._editor.getInstance(),F=E.one("body").one(".selection");if(!F){G=true;}D.Object.each(this.get("activeButtons"),function(J,I){var H=null;switch(J){case"bold":H=G?false:(F&&F.one("b")!==null);return this._buttonDict[J].setValue(H);case"italic":H=G?false:(F&&F.one("i")!==null);return this._buttonDict[J].setValue(H);case"underline":H=G?false:(F&&F.one("u")!==null);return this._buttonDict[J].setValue(H);}},this);},_onButtonEvent:function(F,L){var H=this._editor.getInstance(),J=H.one("body"),E=J.one(".main"),G=E.one(".selection"),N=this._buttonDict[F].getValue(),I=null,K=null,M=null;if(!G){if(this._cssButtons.indexOf(F)!=-1){return this._updateMainStyle(F);}else{if(F==="reset"){this._resetSelection(true);return D.Bewype.Utils.setCssDict(E,this._oMainCssdict);}}}if(G){I=this._getWorkingTagName(F);this._removeTag(G,I,F);if(N){K=D.Node.create("<"+I+"></"+I+">");if(this._cssButtons.indexOf(F)!=-1){K.setStyle(D.Bewype.Utils.camelize(F),N);if(F==="background-color"){K.setStyle("display","inline-block");}}M=D.Node.create('<span class="selection"></span>');M.append(K);M.one(I).append(this._getInnerHTML(G));G.replace(M);}else{if(F==="reset"){this._resetSelection();this._refreshButtons(true);}}this._refreshSelectionNode();}}});D.namespace("Bewype");D.Bewype.Editor=B;},"@VERSION@",{requires:["bewype-button","bewype-utils","dataschema","editor","json-stringify","plugin","stylesheet"]});