YUI.add("bewype-editor",function(D){var C="",A="",B=null;C+='<div class="{editorClass}-place">';C+="</div>";A+='<div class="{editorClass}">';A+="</div>";B=function(E){B.superclass.constructor.apply(this,arguments);};B.NAME="bewypeEditor";B.NS="bewypeEditor";B.ATTRS={editorClass:{value:"yui3-bewype-editor",writeOnce:true,validator:function(E){return D.Lang.isString(E);}},activeButtons:{value:["bold","italic","underline","font-family","font-size","color","background-color"],writeOnce:true},panelNode:{value:null,writeOnce:true},selectionColor:{value:"#ddd",writeOnce:true,validator:function(E){return D.Lang.isString(E);}}};D.extend(B,D.Plugin.Base,{_editor:null,_buttonDict:{},_fontDict:{},_toggleButtons:["bold","italic","underline"],_pickerButtons:["font-family","font-size","color","background-color"],_pickerObjDict:{"font-family":D.Bewype.PickerFontFamily,"font-size":D.Bewype.PickerFontSize,"color":D.Bewype.PickerColor,"background-color":D.Bewype.PickerColor},_tagButtons:["bold","italic","underline"],_cssButtons:["font-family","font-size","color","background-color"],_selectedNodeList:null,_oMainCssdict:{},_initEditor:function(){var E=this.get("host"),F=this.get("editorClass"),H=null,G=new D.Node.create('<div><div class="main" /></div>');G.one(".main").append(this._getInnerHTML(E));E.set("innerHTML","");H=new D.Node.create(D.substitute(C,{editorClass:F}));E.append(H);this._editor=new D.EditorBase({content:G.get("innerHTML")});this._editor.render(H);this._editor.after("nodeChange",D.bind(this._onEditorChange,this));},_initContent:function(){var F=this.get("host"),E=D.Bewype.Utils.getCssDict(F),G=this.get("editorClass")+"-place",K=F.one("."+G),I=this._editor.getInstance().one("body"),H=I.one(".main"),J=null;I.setStyle("cssText","padding: 0; margin: 0;");J=function(M,Q){var R=["height","width"].indexOf(M)!=-1,P=M.split("-"),O=P.indexOf("border")!=-1,N=P.indexOf("font")!=-1,L=P.indexOf("padding")!=-1;if(R||O||L){K.setStyle(D.Bewype.Utils.camelize(M),Q);}else{if(M){this._oMainCssdict[M]=Q;H.setStyle(D.Bewype.Utils.camelize(M),Q);}}if(N){this._fontDict[M]=Q;}return Q;};D.JSON.stringify(E,D.bind(J,this));F.setStyle("cssText","");},__buttonFactory:function(G,E,H){var F=this.get("panelNode"),I=this.get("editorClass"),K=null,J=null;K=new D.Node.create(D.substitute(A,{editorClass:I+"-"+E+"-"+G}));F.append(K);H.render(K);if(E==="button"){J="button:onClick";}else{J="button:onChange";}H.on(J,D.bind(this._onButtonEvent,this,G));this._buttonDict[G]=H;},_addButton:function(E){var F=new D.Bewype.Button({label:E});this.__buttonFactory(E,"button",F);},_addToggleButton:function(E){var F=new D.Bewype.ButtonToggle({label:E});this.__buttonFactory(E,"toggle-button",F);},_addPickerButton:function(E,G){var F=new D.Bewype.ButtonPicker({label:E,pickerObj:G});this.__buttonFactory(E,"picker-button",F);},_initPanel:function(){this._addButton("reset");var E=this.get("activeButtons");D.Object.each(this._toggleButtons,function(G,F){if(E.indexOf(G)!=-1){this._addToggleButton(G);}},this);D.Object.each(this._pickerButtons,function(G,F){if(E.indexOf(G)!=-1){this._addPickerButton(G,this._pickerObjDict[G]);}},this);},initializer:function(E){this._initEditor();this._initContent();this._initPanel();},destructor:function(){if(!this._editor){return;}var K=this.get("host"),L=this.get("panelNode"),J=this.get("editorClass"),H="."+J+"-place",M=K.one(H),G=this._editor.getInstance().one("body"),E=G.one(".main"),F=E.one(".selection"),I=null;this._editor.hide();F.replace(this._getInnerHTML(F));K.set("innerHTML",E.get("innerHTML"));I=function(N,O,P){if(O){if(N==="content"&&O.split("-").indexOf("padding")!=-1){}else{K.setStyle(D.Bewype.Utils.camelize(O),P);}}return P;};D.JSON.stringify(D.Bewype.Utils.getCssDict(M),D.bind(I,this,"place"));D.JSON.stringify(D.Bewype.Utils.getCssDict(E),D.bind(I,this,"content"));this._editor.destroy();D.Object.each(this.get("activeButtons"),function(O,N){this._buttonDict[O].destroy();delete (this._buttonDict[O]);L.one("."+J+"-toggle-button-"+O).remove();},this);this._buttonDict={};this._fontDict={};},_hasLeftBlank:function(E){if(E.length===0){return false;}else{if(E.substring(0,1).trim().length===0){return true;}}return false;},_hasRightBlank:function(E){if(E.length===0){return false;}else{if(E.substring(E.length-1,E.length).trim().length===0){return true;}}return false;},_getInnerHTML:function(H,F){var G=H._node?H._node:H,E=G.innerHTML,I="";I+=this._hasLeftBlank(E)?"&nbsp;":"";I+=E.trim();I+=this._hasRightBlank(E)?"&nbsp;":"";return F?I:I.trim()===""?null:new D.Node.create(I);},_getWorkingTagName:function(E){switch(E){case"bold":return"b";case"italic":return"i";case"underline":return"u";default:return"span";}},_removeTag:function(F,E,G){if(F){F.all(E).each(function(J,I){var K=null,H=null,L=null;if(G){K=D.Bewype.Utils.getCssDict(J);if(K[G]){delete (K[G]);}D.Bewype.Utils.setCssDict(J,K);L=D.Object.keys(K).length;if(L!==0){return;}}H=this._getInnerHTML(J);if(!H){J.remove();}else{J.replace(this._getInnerHTML(J));}},this);}},_updateMainStyle:function(G,J){var I=this.get("host"),L=["height","width"].indexOf(G)!=-1,K=G.split("-"),E=K.indexOf("padding")!=-1,H=J?J:null,F=this._buttonDict[G].getValue();if(!H){if(L||E){H=I.one("."+this.get("editorClass")+"-place");}else{H=this._editor.getInstance().one(".main");}}H.setStyle(D.Bewype.Utils.camelize(G),F);},_clearSelection:function(F,E){if(F.clear){F.clear();}else{if(F.removeAllRanges){E.detach();F.removeAllRanges();}else{return;}}},_isFocusNodeFisrt:function(N){var G=this._editor.getInstance(),J=G.one("body").one(".main")._node,K=N.anchorNode,P=N.focusNode,F=N.anchorOffset,O=N.focusOffset,L=J.innerHTML?J.innerHTML:J.textContent,M=K.innerHTML?K.innerHTML:K.textContent,E=P.innerHTML?P.innerHTML:P.textContent,I=0,H=0;if(K==P){return O<F;}else{I=L.indexOf(M);H=L.indexOf(E);return H<I;}},_ensureRangeFirstNode:function(H,E,K){var G=this._editor.getInstance(),L=G.one("body").one(".main"),F=L._node,J=0;if(K.parentNode!=F){try{while(K.parentNode&&K.parentNode!=F){K=K.parentNode;J+=1;if(J==10){break;
}}E.setStartBefore(K);}catch(I){this._clearSelection(H,E);this._removeTag(L,".selection");return false;}}else{if(H.anchorOffset===0&&!H.anchorNode.previousSibling){E.setStart(F,0);}}return true;},_ensureRangeLastNode:function(H,E,K){var G=this._editor.getInstance(),L=G.one("body").one(".main"),F=L._node,J=0;if(K.parentNode!=F){try{while(K.parentNode&&K.parentNode!=F){K=K.parentNode;J+=1;if(J==10){break;}}E.setEndAfter(K);}catch(I){this._clearSelection(H,E);this._removeTag(L,".selection");return false;}}return true;},_onEditorChange:function(K){var M=this.get("host"),H=this._editor.getInstance(),I=H.one("body"),E=I.one(".main"),G=E.one(".selection"),N=null,L=null,O=null,F=null;if(K.changedEvent.type=="dblclick"){}else{if(K.changedEvent.type=="mouseup"){N=D.Bewype.Utils.getSelection(M);L=D.Bewype.Utils.getRange(N);if(!N.anchorNode||!N.focusNode){this._clearSelection(N,L);return this._removeTag(E,".selection");}if(G){G.replace(this._getInnerHTML(G));}if(N.anchorNode!=N.focusNode||N.anchorOffset!=N.focusOffset){if(this._isFocusNodeFisrt(N)){O=N.focusNode;F=N.anchorNode;}else{O=N.anchorNode;F=N.focusNode;}if(!this._ensureRangeFirstNode(N,L,O)){return;}if(!this._ensureRangeLastNode(N,L,F)){return;}try{G=D.Node.create('<span class="selection"></span>');E.append(G);L.surroundContents(E.one(".selection")._node);}catch(J){this._clearSelection(N,L);return this._removeTag(E,".selection");}this._clearSelection(N,L);}else{this._removeTag(E,".selection");}this._refreshButtons();this._refreshSelectionNode();}}},_refreshSelectionNode:function(){var E=this._editor.getInstance(),F=E.one("body").one(".selection"),G=this.get("selectionColor");if(!F){return;}F.setStyle("backgroundColor",G);F.setStyle("display","inline-block");},_resetNode:function(E){var G=this._editor.getInstance(),H=G.one("body"),F=E?H.one(".main"):H.one(".selection");if(!F){return;}this._removeTag(F,"span");this._removeTag(F,"b");this._removeTag(F,"i");this._removeTag(F,"u");},_refreshButtons:function(G){var E=this._editor.getInstance(),F=E.one("body").one(".selection");if(!F){return;}D.Object.each(this.get("activeButtons"),function(J,I){var H=null;switch(J){case"bold":H=G?false:F&&F.one("b")!==null;this._buttonDict[J].setValue(H);break;case"italic":H=G?false:F&&F.one("i")!==null;this._buttonDict[J].setValue(H);break;case"underline":H=G?false:F&&F.one("u")!==null;this._buttonDict[J].setValue(H);break;}},this);},_onButtonEvent:function(F,L){var H=this._editor.getInstance(),J=H.one("body"),E=J.one(".main"),G=E.one(".selection"),N=this._buttonDict[F].getValue(),I=null,K=null,M=null;if(!G){if(this._cssButtons.indexOf(F)!=-1){return this._updateMainStyle(F);}else{if(F==="reset"){this._resetNode(true);return D.Bewype.Utils.setCssDict(E,this._oMainCssdict);}}}if(G){I=this._getWorkingTagName(F);this._removeTag(G,I,F);if(N){K=D.Node.create("<"+I+"></"+I+">");if(this._cssButtons.indexOf(F)!=-1){K.setStyle(D.Bewype.Utils.camelize(F),N);}M=D.Node.create('<span class="selection"></span>');M.append(K);M.one(I).append(this._getInnerHTML(G));G.replace(M);}else{if(F==="reset"){this._resetNode();this._refreshButtons(true);}}this._refreshSelectionNode();}}});D.namespace("Bewype");D.Bewype.Editor=B;},"@VERSION@",{requires:["bewype-button","bewype-utils","dataschema","editor","json-stringify","plugin","stylesheet"]});